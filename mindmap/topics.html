<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lseshan.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Markmap  * {   margin: 0;   padding: 0; } #mindmap {   display: block;   width: 100vw;   height: 100vh; }      ((r) &#x3D;&gt; {           setTimeout(r);         })(() &#x3D;&gt; {   const { markmap, mm } &#x3D; win">
<meta property="og:type" content="website">
<meta property="og:title" content="say-shan">
<meta property="og:url" content="http://lseshan.github.io/mindmap/topics.html">
<meta property="og:site_name" content="say-shan">
<meta property="og:description" content="Markmap  * {   margin: 0;   padding: 0; } #mindmap {   display: block;   width: 100vw;   height: 100vh; }      ((r) &#x3D;&gt; {           setTimeout(r);         })(() &#x3D;&gt; {   const { markmap, mm } &#x3D; win">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-11T05:50:55.522Z">
<meta property="article:modified_time" content="2025-12-11T05:50:55.522Z">
<meta property="article:author" content="Lakshmi Narasimhan Seshan">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://lseshan.github.io/mindmap/topics">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"en","comments":true,"permalink":"http://lseshan.github.io/mindmap/topics.html","path":"mindmap/topics.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | say-shan
</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">say-shan</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section">About</a></li><li class="menu-item menu-item-blogs"><a href="/blogs/" rel="section">blogs</a></li><li class="menu-item menu-item-mindmap"><a href="/mindmap/" rel="section">mindmap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lakshmi Narasimhan Seshan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner page posts-expand">


    
    
    
    <div class="post-block" lang="en"><header class="post-header">

<h1 class="post-title" itemprop="name headline">
</h1>

<div class="post-meta-container">
</div>

</header>

      
      
      
      <div class="post-body">
          <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.5/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.5/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.5/dist/index.js"></script><script>((r) => {
          setTimeout(r);
        })(() => {
  const { markmap, mm } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute("style", "position:absolute;bottom:20px;right:20px");
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"topics","children":[{"content":"AI networking","children":[{"content":"General Concepts","children":[{"content":"APP Requirements from network","children":[{"content":"low and predictable latency","children":[],"payload":{"tag":"li","lines":"11,12"}},{"content":"high bandwidth (elephant flow) but bursty","children":[],"payload":{"tag":"li","lines":"12,13"}},{"content":"low entrophy (unlike DC)","children":[],"payload":{"tag":"li","lines":"13,14"}},{"content":"unordered is fine","children":[],"payload":{"tag":"li","lines":"14,15"}}],"payload":{"tag":"h3","lines":"10,11"}},{"content":"Network Traffic characteristics","children":[{"content":"Low entrophy","children":[],"payload":{"tag":"li","lines":"16,17"}},{"content":"Less Load balancing on multiple path. Multiple QP over NIC-NIC","children":[],"payload":{"tag":"li","lines":"17,18"}},{"content":"Incast traffic patterns (eg All gather)","children":[{"content":"Causes HOL (which increases latency)","children":[],"payload":{"tag":"li","lines":"19,20"}},{"content":"Buffer pressures","children":[],"payload":{"tag":"li","lines":"20,21"}}],"payload":{"tag":"li","lines":"18,21"}}],"payload":{"tag":"h3","lines":"15,16"}},{"content":"Network requirements <a href=\"https://www.cisco.com/c/en/us/td/docs/dcn/whitepapers/cisco-addressing-ai-ml-network-challenges.html\">good review</a>","children":[{"content":"lossless","children":[{"content":"acheived by credit based flow control or<br>\nby PFC in ethernet","children":[],"payload":{"tag":"li","lines":"23,25"}}],"payload":{"tag":"li","lines":"22,25"}},{"content":"loss of packets due to","children":[{"content":"Congestion","children":[{"content":"Buffer full","children":[{"content":"Good Buffer allocation","children":[{"content":"Incast Pattern","children":[],"payload":{"tag":"li","lines":"29,30"}},{"content":"Outcast Pattern","children":[],"payload":{"tag":"li","lines":"30,31"}},{"content":"Low entrophy traffic pattern","children":[],"payload":{"tag":"li","lines":"31,32"}},{"content":"Bursty elephant flow","children":[],"payload":{"tag":"li","lines":"32,33"}}],"payload":{"tag":"li","lines":"28,33"}},{"content":"Bad Buffer allocation","children":[],"payload":{"tag":"li","lines":"33,34"}}],"payload":{"tag":"li","lines":"27,34"}},{"content":"HOL","children":[{"content":"Nature of certain LLC flow control like Go-Back N","children":[],"payload":{"tag":"li","lines":"35,36"}},{"content":"PFC can cause HOL","children":[],"payload":{"tag":"li","lines":"36,37"}}],"payload":{"tag":"li","lines":"34,37"}},{"content":"Packet retransmission due to link failures","children":[],"payload":{"tag":"li","lines":"37,38"}}],"payload":{"tag":"li","lines":"26,38"}},{"content":"link failures","children":[],"payload":{"tag":"li","lines":"38,39"}}],"payload":{"tag":"li","lines":"25,39"}},{"content":"Loss mitigation","children":[{"content":"Link layer Level","children":[{"content":"\n<p data-lines=\"41,42\">Packet trim to notify congestion</p>","children":[],"payload":{"tag":"li","lines":"41,42"}},{"content":"\n<p data-lines=\"42,43\">PFC/ECN</p>","children":[],"payload":{"tag":"li","lines":"42,43"}},{"content":"\n<p data-lines=\"43,45\">Packet spraying for effective link utilisation<br>\nNeed reordering at the destination</p>","children":[],"payload":{"tag":"li","lines":"43,45"}},{"content":"\n<p data-lines=\"45,47\">DLB - based on the speed of port tx, buffers<br>\nsolves: Elephant flow, link failures, hash polarisation</p>","children":[],"payload":{"tag":"li","lines":"45,48"}},{"content":"\n<p data-lines=\"48,50\">SR can be used instead of Go-BackN<br>\nneeds buffer at the destination</p>","children":[],"payload":{"tag":"li","lines":"48,50"}}],"payload":{"tag":"li","lines":"40,50"}},{"content":"IP layer","children":[{"content":"Enhanced ECMP (look into the QP)","children":[],"payload":{"tag":"li","lines":"51,52"}},{"content":"ECMP random spraying","children":[],"payload":{"tag":"li","lines":"52,53"}},{"content":"Adaptive routing<br>\nNeed reordering at the destination","children":[],"payload":{"tag":"li","lines":"53,55"}}],"payload":{"tag":"li","lines":"50,55"}},{"content":"","children":[],"payload":{"tag":"li","lines":"55,56"}}],"payload":{"tag":"li","lines":"39,56"}},{"content":"Incast trafic pattern","children":[{"content":"PFC over RoCEv2 (but deprecated due to HOL)","children":[],"payload":{"tag":"li","lines":"57,58"}},{"content":"packet trimming instead","children":[],"payload":{"tag":"li","lines":"58,59"}}],"payload":{"tag":"li","lines":"56,59"}},{"content":"Load balancing (less utilisation)","children":[{"content":"Packet spraying like UEC (needs reordering)","children":[],"payload":{"tag":"li","lines":"60,61"}},{"content":"QP Scaling in CCL","children":[],"payload":{"tag":"li","lines":"61,62"}}],"payload":{"tag":"li","lines":"59,62"}}],"payload":{"tag":"h3","lines":"21,22"}},{"content":"Host networking","children":[{"content":"Characteristics","children":[{"content":"10 - 100ms internet / wide variability","children":[],"payload":{"tag":"li","lines":"64,65"}},{"content":"100us 0 1ms / medium variability","children":[],"payload":{"tag":"li","lines":"65,66"}},{"content":"10s of us bursty high bandwidth synchronised predicatability<br>\nlow and predictable latency","children":[],"payload":{"tag":"li","lines":"66,68"}}],"payload":{"tag":"li","lines":"63,68"}}],"payload":{"tag":"h3","lines":"62,63"}},{"content":"Metrics to watchout","children":[{"content":"Bandwidth usage","children":[],"payload":{"tag":"li","lines":"69,70"}},{"content":"Latency (esp 99p )","children":[],"payload":{"tag":"li","lines":"70,71"}},{"content":"BDP - Bandwidth delay product (Bandwidth * RTT)<br>\nUsed to determine the size of reorder buffer, size of the bitmaps needed","children":[],"payload":{"tag":"li","lines":"71,74"}}],"payload":{"tag":"h3","lines":"68,69"}},{"content":"Scalability <img src=\"e53c0384.png\">","children":[{"content":"Scale up","children":[{"content":"Speed needs &gt; Scale out","children":[],"payload":{"tag":"li","lines":"77,78"}},{"content":"Simpler single tier topo","children":[],"payload":{"tag":"li","lines":"78,79"}},{"content":"Well known endpoints, static conn. setup possible","children":[],"payload":{"tag":"li","lines":"79,81"}}],"payload":{"tag":"h4","lines":"76,77"}},{"content":"Scale out","children":[{"content":"leverages packet spraying","children":[],"payload":{"tag":"li","lines":"82,83"}},{"content":"Multiple tier clos/rail based topo","children":[],"payload":{"tag":"li","lines":"83,84"}},{"content":"<img src=\"/Users/lakshmis/personal/localweb/site/mindmap/e53c0384.png\" alt=\"picture\">","children":[],"payload":{"tag":"li","lines":"84,85"}}],"payload":{"tag":"h4","lines":"81,82"}}],"payload":{"tag":"h3","lines":"74,75"}}],"payload":{"tag":"h2","lines":"9,10"}},{"content":"Physical Layer Tech","children":[{"content":"Infiniband","children":[{"content":"lossless network (builtin)","children":[{"content":"has credit based flow control (CBFC)","children":[],"payload":{"tag":"li","lines":"88,89"}},{"content":"congestion managment (ECN)","children":[],"payload":{"tag":"li","lines":"89,90"}},{"content":"","children":[],"payload":{"tag":"li","lines":"90,92"}}],"payload":{"tag":"li","lines":"87,92"}}],"payload":{"tag":"h4","lines":"86,87"}},{"content":"Ethernet","children":[{"content":"lossy(builtin)","children":[],"payload":{"tag":"li","lines":"93,94"}},{"content":"made lossless by","children":[{"content":"PFC <a href=\"https://www.microsoft.com/en-us/research/wp-content/uploads/2016/11/rdma_sigcomm2016.pdf\">PFC issues</a>","children":[{"content":"PFC sends pause frames","children":[],"payload":{"tag":"li","lines":"96,97"}},{"content":"XOFF for certain prioroties stop the traffic","children":[],"payload":{"tag":"li","lines":"97,98"}},{"content":"XON once the threshold is lower","children":[],"payload":{"tag":"li","lines":"98,99"}},{"content":"Problems","children":[{"content":"can itself cause high latency due to HOL","children":[],"payload":{"tag":"li","lines":"100,101"}},{"content":"Congestion spreading","children":[],"payload":{"tag":"li","lines":"101,102"}},{"content":"PFC storms - NIC malfunction - watchdog","children":[],"payload":{"tag":"li","lines":"102,103"}},{"content":"PFC deadlock (complex scenario with 2 servers down)","children":[],"payload":{"tag":"li","lines":"103,104"}}],"payload":{"tag":"li","lines":"99,104"}},{"content":"Mitigation","children":[{"content":"Combine with ECN and keep PFC as last resort","children":[],"payload":{"tag":"li","lines":"105,106"}},{"content":"PFC watchdogs to control PFC storms","children":[],"payload":{"tag":"li","lines":"106,107"}},{"content":"L2 Priority Code Point (PCP)","children":[],"payload":{"tag":"li","lines":"107,108"}},{"content":"L3 DSCP","children":[],"payload":{"tag":"li","lines":"108,109"}},{"content":"Switch maps DSCP to traffic class and queue","children":[],"payload":{"tag":"li","lines":"109,110"}},{"content":"Thresholds","children":[{"content":"Xoff","children":[],"payload":{"tag":"li","lines":"111,112"}},{"content":"Xon - &lt;  generate PFC with quanta 0 &gt;","children":[],"payload":{"tag":"li","lines":"112,113"}}],"payload":{"tag":"li","lines":"110,113"}},{"content":"CEV has 8 bit traffic class","children":[],"payload":{"tag":"li","lines":"113,114"}},{"content":"0x8809 PFC, opcode 0x0101","children":[],"payload":{"tag":"li","lines":"114,115"}}],"payload":{"tag":"li","lines":"104,115"}}],"payload":{"tag":"li","lines":"95,115"}},{"content":"ECN","children":[{"content":"uses tos field in ip header","children":[],"payload":{"tag":"li","lines":"116,117"}},{"content":"00 - ECN not capable 01 ECN Capable 10 - ECN Capable  11 - CE","children":[],"payload":{"tag":"li","lines":"117,118"}},{"content":"Thresholds:","children":[{"content":"WRED minimum - randomly mark the packets","children":[],"payload":{"tag":"li","lines":"119,120"}},{"content":"WRED maximum all packets are parkets","children":[],"payload":{"tag":"li","lines":"120,121"}},{"content":"Drop","children":[],"payload":{"tag":"li","lines":"121,122"}}],"payload":{"tag":"li","lines":"118,122"}},{"content":"CNP","children":[{"content":"On receiving ECN, NIC generates CNP","children":[],"payload":{"tag":"li","lines":"123,124"}},{"content":"DSCP is set to 48","children":[],"payload":{"tag":"li","lines":"124,125"}},{"content":"dest udp port:4791","children":[],"payload":{"tag":"li","lines":"125,126"}},{"content":"Src:0","children":[],"payload":{"tag":"li","lines":"126,127"}},{"content":"BTH has the Senders QP","children":[],"payload":{"tag":"li","lines":"127,128"}},{"content":"Different from QCN/CN","children":[],"payload":{"tag":"li","lines":"128,129"}}],"payload":{"tag":"li","lines":"122,129"}}],"payload":{"tag":"li","lines":"115,129"}},{"content":"DCQCN:<a href=\"https://www.wwt.com/article/understanding-data-center-quantized-congestion-notification-dcqcn\">DCQN</a>","children":[{"content":"Solves HOL due to PFC and packet loss just with ECN","children":[],"payload":{"tag":"li","lines":"130,131"}},{"content":"","children":[],"payload":{"tag":"li","lines":"131,132"}}],"payload":{"tag":"li","lines":"129,132"}},{"content":"DCB","children":[],"payload":{"tag":"li","lines":"132,133"}},{"content":"FALCON, SRD, SUE uses other ways to achieve this lossless ness","children":[],"payload":{"tag":"li","lines":"133,134"}},{"content":"Reliability: ACKS","children":[],"payload":{"tag":"li","lines":"134,135"}},{"content":"CC: get signals and control","children":[],"payload":{"tag":"li","lines":"135,136"}},{"content":"","children":[],"payload":{"tag":"li","lines":"136,137"}}],"payload":{"tag":"li","lines":"94,137"}}],"payload":{"tag":"h4","lines":"92,93"}}],"payload":{"tag":"h2","lines":"85,86"}},{"content":"UEC","children":[{"content":"<a href=\"https://arxiv.org/html/2508.08906v1\">Reference</a>","children":[],"payload":{"tag":"li","lines":"138,139"}},{"content":"Transport Layer","children":[{"content":"EV - entrophy value 4793","children":[{"content":"Can be changed for each packet","children":[],"payload":{"tag":"li","lines":"141,142"}},{"content":"helps is utilising the links","children":[],"payload":{"tag":"li","lines":"142,143"}}],"payload":{"tag":"li","lines":"140,143"}},{"content":"Packet loss detection","children":[{"content":"Packet trimming","children":[],"payload":{"tag":"li","lines":"144,145"}},{"content":"Distance between last PSN and lost PSN","children":[],"payload":{"tag":"li","lines":"145,146"}},{"content":"Keep track of (EV, PSN) as ordered list (not sure how it distinguishes delay vs loss)","children":[],"payload":{"tag":"li","lines":"146,147"}}],"payload":{"tag":"li","lines":"143,147"}},{"content":"Packet Spraying:","children":[{"content":"Uses EV to spray, bitmaps + SACKs, to limit bitmap, max PFN RANGE is defined","children":[],"payload":{"tag":"li","lines":"148,149"}}],"payload":{"tag":"li","lines":"147,149"}},{"content":"Congestion Controll - NSCC","children":[{"content":"Use ECN + RTT; ECN; set; low RTT -&gt; congestion starting<br>\nECN set; high RTT -&gt; in congestion<br>\nECN not set; low RTT -&gt; low traffic<br>\nECN not set; high RTT -&gt; congestion going down","children":[],"payload":{"tag":"li","lines":"150,154"}},{"content":"RCCC: Receiver Credit Congestion control","children":[{"content":"uses receiver credits","children":[],"payload":{"tag":"li","lines":"155,156"}},{"content":"solves incast problem but not in network and outcast","children":[],"payload":{"tag":"li","lines":"156,157"}}],"payload":{"tag":"li","lines":"154,157"}}],"payload":{"tag":"li","lines":"149,157"}}],"payload":{"tag":"li","lines":"139,157"}},{"content":"Link Layer","children":[{"content":"Link layer retry - Go Back N similar to eshim","children":[{"content":"Reason is this is link layer and congestion doesn't play a role","children":[],"payload":{"tag":"li","lines":"159,160"}},{"content":"only FEC or link layer errors. (very interesting and confident take)","children":[],"payload":{"tag":"li","lines":"160,161"}}],"payload":{"tag":"li","lines":"158,161"}},{"content":"CBFC - 20 bit cyclic counter to maintain the credit;","children":[],"payload":{"tag":"li","lines":"161,162"}}],"payload":{"tag":"li","lines":"157,162"}}],"payload":{"tag":"h2","lines":"137,138"}},{"content":"Flow Control/Link Level","children":[{"content":"\n<p data-lines=\"163,164\">UALINK</p>","children":[{"content":"Target Scale up fabric","children":[],"payload":{"tag":"li","lines":"164,165"}},{"content":"Requirements","children":[{"content":"Significantly higher bandwidth than a scale out","children":[],"payload":{"tag":"li","lines":"166,167"}}],"payload":{"tag":"li","lines":"165,167"}},{"content":"Characteristics","children":[{"content":"Single stage","children":[],"payload":{"tag":"li","lines":"168,169"}},{"content":"multiple parallel fabric planes with swich for each plane","children":[],"payload":{"tag":"li","lines":"169,170"}},{"content":"memory semantics as RDMA able to load and store;","children":[],"payload":{"tag":"li","lines":"170,171"}},{"content":"lossless - GoBack N or Selective Request","children":[],"payload":{"tag":"li","lines":"171,172"}}],"payload":{"tag":"li","lines":"167,172"}}],"payload":{"tag":"li","lines":"163,172"}},{"content":"\n<p data-lines=\"172,173\">SRD</p>","children":[{"content":"Current implementations used ECMP. Doesn't account for congestion","children":[],"payload":{"tag":"li","lines":"173,174"}},{"content":"RoCE: Didnt want to go for it as it needs PFC.","children":[],"payload":{"tag":"li","lines":"174,175"}},{"content":"The protocol","children":[{"content":"reliable but out of order","children":[],"payload":{"tag":"li","lines":"176,177"}},{"content":"in order causes Hol, latency, reduce bandwidth","children":[],"payload":{"tag":"li","lines":"177,178"}},{"content":"Packet spraying based on RTT collected<br>\nCostly to reorder on nic, need big rx buffer<br>\nalso increase averate latency<br>\nDecided to deliver to the host out of order","children":[],"payload":{"tag":"li","lines":"178,182"}},{"content":"Spraying doesn't help in incast","children":[],"payload":{"tag":"li","lines":"182,183"}},{"content":"SRD CC is to prevent queue buildup and drops rather than relying on them","children":[],"payload":{"tag":"li","lines":"183,184"}},{"content":"Uses combination of tx rate, ack rx rate and rtt","children":[],"payload":{"tag":"li","lines":"184,185"}},{"content":"","children":[],"payload":{"tag":"li","lines":"185,187"}}],"payload":{"tag":"li","lines":"175,187"}}],"payload":{"tag":"li","lines":"172,187"}},{"content":"\n<p data-lines=\"187,188\">FALCON <a href=\"https://dl.acm.org/doi/pdf/10.1145/3718958.3754353\">paper</a></p>","children":[{"content":"multi-ULP (upper level protocol)","children":[],"payload":{"tag":"li","lines":"188,189"}},{"content":"delay based congestion control","children":[],"payload":{"tag":"li","lines":"189,190"}},{"content":"multipath load balancing","children":[],"payload":{"tag":"li","lines":"190,191"}},{"content":"hardware based retransmission","children":[],"payload":{"tag":"li","lines":"191,192"}},{"content":"enforces ordering (but AI workloads dont need?)","children":[],"payload":{"tag":"li","lines":"192,193"}},{"content":"Uses SACKS","children":[],"payload":{"tag":"li","lines":"193,194"}},{"content":"Critique on RoCE (not sure v2 or v1 or both)","children":[{"content":"3 limitations","children":[],"payload":{"tag":"li","lines":"195,196"}},{"content":"Go-Back-N moved to SR but for Wr/Rd","children":[],"payload":{"tag":"li","lines":"196,197"}},{"content":"SR results in out of order delivery","children":[],"payload":{"tag":"li","lines":"197,198"}},{"content":"No multipathing. So adaptive routing cannot be used","children":[],"payload":{"tag":"li","lines":"198,199"}},{"content":"CC is add on.and external like ECN, CNP<br>\nnot baked into the packet path<br>\nslow and coarse","children":[],"payload":{"tag":"li","lines":"199,202"}}],"payload":{"tag":"li","lines":"194,202"}},{"content":"Implementation","children":[{"content":"Reliability","children":[{"content":"Rx send bitmap of SACKS, uses PSN","children":[],"payload":{"tag":"li","lines":"204,205"}},{"content":"Tail loss Probes","children":[],"payload":{"tag":"li","lines":"205,206"}},{"content":"Loss  vs reordering:","children":[{"content":"Receiver sends Acks with Bitmap","children":[],"payload":{"tag":"li","lines":"207,208"}},{"content":"Sender computes the time embdeded in the ACK say 10s","children":[],"payload":{"tag":"li","lines":"208,209"}},{"content":"Sender then computes the sent time of PSN 2 and ACK time of PSN 5. 10 - 9s &gt; (reorder time(rack_rto)) and pakcet lost","children":[],"payload":{"tag":"li","lines":"209,210"}}],"payload":{"tag":"li","lines":"206,210"}},{"content":"Sender retransmits","children":[],"payload":{"tag":"li","lines":"210,211"}},{"content":"TLP is needed when the last packets are lost","children":[],"payload":{"tag":"li","lines":"211,212"}},{"content":"TLP tickles receiver to send ACKs","children":[],"payload":{"tag":"li","lines":"212,213"}},{"content":"used RACK-TLP to differentiate loss vs reorder","children":[],"payload":{"tag":"li","lines":"213,214"}}],"payload":{"tag":"li","lines":"203,214"}},{"content":"Congestion control","children":[{"content":"Programmable congestion: (t4-t1) - (t3-t2)","children":[],"payload":{"tag":"li","lines":"215,216"}},{"content":"Nic Rx buffer occupance is also sent<br>\nThis handles buffer buildup for ordering packets end host bottlenecks","children":[],"payload":{"tag":"li","lines":"216,218"}}],"payload":{"tag":"li","lines":"214,218"}},{"content":"Uses RACK-TLP per flow to avoid spurious tx","children":[],"payload":{"tag":"li","lines":"218,219"}},{"content":"rx bitmap allows acknowledging packets across flow)","children":[],"payload":{"tag":"li","lines":"219,220"}},{"content":"FAE: prefetches the connections stated. controls cwnd (fcwnd, ncwnd)","children":[],"payload":{"tag":"li","lines":"220,221"}},{"content":"Connections, each connection has multiple flows","children":[],"payload":{"tag":"li","lines":"221,222"}},{"content":"","children":[],"payload":{"tag":"li","lines":"222,223"}},{"content":"Multipathing","children":[{"content":"not just multiple path by hashing","children":[],"payload":{"tag":"li","lines":"224,225"}},{"content":"dynamically choose the path based on congestion signal","children":[],"payload":{"tag":"li","lines":"225,226"}},{"content":"","children":[],"payload":{"tag":"li","lines":"226,227"}}],"payload":{"tag":"li","lines":"223,227"}},{"content":"Observations:","children":[{"content":"Loss Recovery: Performs better due to SACK/bitmap","children":[],"payload":{"tag":"li","lines":"228,229"}},{"content":"Reordering: Can distinguish reorde vs loss","children":[{"content":"AR doesn't perform well(Probably AR is for lossless fabric and not lossy)","children":[],"payload":{"tag":"li","lines":"230,231"}}],"payload":{"tag":"li","lines":"229,231"}},{"content":"Congestion control","children":[{"content":"Fabric congestion: By incast","children":[],"payload":{"tag":"li","lines":"232,233"}},{"content":"End host congesion: By pcie slow down; RxBuffer occupancy is carries in the ACK","children":[],"payload":{"tag":"li","lines":"233,235"}}],"payload":{"tag":"li","lines":"231,235"}}],"payload":{"tag":"li","lines":"227,235"}}],"payload":{"tag":"li","lines":"202,235"}}],"payload":{"tag":"li","lines":"187,235"}},{"content":"\n<p data-lines=\"235,236\">SUE <a href=\"https://docs.broadcom.com/doc/scale-up-ethernet-framework\">Website</a></p>","children":[{"content":"On Chip SUE, Connects to 1024 SUE","children":[],"payload":{"tag":"li","lines":"236,237"}},{"content":"also via Switch (but one hop)","children":[],"payload":{"tag":"li","lines":"237,238"}},{"content":"SUE has Mgmt, XPU command, Ethernet i/f","children":[],"payload":{"tag":"li","lines":"238,239"}},{"content":"\n<h2 data-lines=\"239,241\">Scale out assumptions</h2>","children":[],"payload":{"tag":"li","lines":"239,241"}},{"content":"Scale up assumptions","children":[{"content":"Simpler single-path tranport","children":[],"payload":{"tag":"li","lines":"242,243"}},{"content":"go-back-N for infrequent losses","children":[],"payload":{"tag":"li","lines":"243,244"}},{"content":"corruption loss LLR (like fcs checksum)","children":[],"payload":{"tag":"li","lines":"244,245"}},{"content":"For go-back-N support, use PFC or CBFC.","children":[],"payload":{"tag":"li","lines":"245,246"}},{"content":"To avoid triggering flow-contorl and side effct HOL use ECN or state of the art.","children":[],"payload":{"tag":"li","lines":"246,247"}},{"content":"Load balance across by external SUE","children":[],"payload":{"tag":"li","lines":"247,248"}},{"content":"incast issue is the only problem","children":[],"payload":{"tag":"li","lines":"248,249"}}],"payload":{"tag":"li","lines":"241,249"}},{"content":"\n<h2 data-lines=\"249,251\">Characteristics</h2>","children":[],"payload":{"tag":"li","lines":"249,251"}},{"content":"Headers","children":[{"content":"AFH 2 headers","children":[{"content":"12B/6B","children":[],"payload":{"tag":"li","lines":"253,254"}},{"content":"SA/DA is overloaded","children":[],"payload":{"tag":"li","lines":"254,255"}}],"payload":{"tag":"li","lines":"252,255"}},{"content":"AFH 1 headers","children":[{"content":"Use same DA/SA","children":[],"payload":{"tag":"li","lines":"256,257"}},{"content":"2 byte Shim format contains (TTL, DSCP, ECN, flow label) (typical ip headers)","children":[],"payload":{"tag":"li","lines":"257,258"}}],"payload":{"tag":"li","lines":"255,258"}}],"payload":{"tag":"li","lines":"251,258"}},{"content":"Other features","children":[{"content":"Flow Control","children":[{"content":"PFC","children":[{"content":"Two lossless classes - request and response","children":[],"payload":{"tag":"li","lines":"261,262"}}],"payload":{"tag":"li","lines":"260,262"}},{"content":"CBFC","children":[{"content":"32 classes","children":[],"payload":{"tag":"li","lines":"263,264"}},{"content":"(TBD- Check UEC)","children":[],"payload":{"tag":"li","lines":"264,265"}}],"payload":{"tag":"li","lines":"262,265"}}],"payload":{"tag":"li","lines":"259,265"}}],"payload":{"tag":"li","lines":"258,265"}},{"content":"Memory semantics","children":[{"content":"one sided semantics (RDMA_READ, RDMA_WRITE)","children":[],"payload":{"tag":"li","lines":"266,267"}}],"payload":{"tag":"li","lines":"265,267"}}],"payload":{"tag":"li","lines":"235,267"}},{"content":"\n<p data-lines=\"267,268\">RoCE</p>","children":[{"content":"Ordering is built in event thougj AI networking doesn't need","children":[],"payload":{"tag":"li","lines":"268,269"}},{"content":"NICs","children":[{"content":"Thor","children":[],"payload":{"tag":"li","lines":"270,271"}},{"content":"Bluefield","children":[],"payload":{"tag":"li","lines":"271,272"}},{"content":"AMD","children":[],"payload":{"tag":"li","lines":"272,273"}}],"payload":{"tag":"li","lines":"269,273"}},{"content":"RoCE GoBack N","children":[{"content":"ESHIM","children":[],"payload":{"tag":"li","lines":"274,275"}}],"payload":{"tag":"li","lines":"273,275"}},{"content":"RoCE SR  Default","children":[{"content":"Need to wait until all the packets arrive","children":[],"payload":{"tag":"li","lines":"276,277"}},{"content":"Selective ACKS / Bitmap based","children":[],"payload":{"tag":"li","lines":"277,278"}}],"payload":{"tag":"li","lines":"275,278"}}],"payload":{"tag":"li","lines":"267,278"}}],"payload":{"tag":"h2","lines":"162,163"}},{"content":"RDMA","children":[{"content":"libfabrics <a href=\"https://www.youtube.com/watch?v=cgiGbny5vdo\">tutorial</a>","children":[{"content":"libfabric API sits between MPI,CCL and different (sockets, RDMA(ibverbs), GPU, posix memory)","children":[],"payload":{"tag":"li","lines":"280,281"}},{"content":"API, provider libraries,","children":[],"payload":{"tag":"li","lines":"281,282"}},{"content":"Blocks","children":[{"content":"Control      -&gt; Discovery","children":[],"payload":{"tag":"li","lines":"283,284"}},{"content":"Communication -&gt; Connection management","children":[],"payload":{"tag":"li","lines":"284,285"}},{"content":"Completion --&gt; Event, completion , queues","children":[],"payload":{"tag":"li","lines":"285,286"}},{"content":"Data xfer -&gt; message, RMA, Atomics, Collectives,","children":[],"payload":{"tag":"li","lines":"286,287"}}],"payload":{"tag":"li","lines":"282,287"}},{"content":"OFI provider","children":[{"content":"Verbs, TCP, UCX, UET","children":[],"payload":{"tag":"li","lines":"288,289"}},{"content":"EFA(AWS)","children":[],"payload":{"tag":"li","lines":"289,290"}},{"content":"CXI (Cray slingshot)","children":[],"payload":{"tag":"li","lines":"290,291"}}],"payload":{"tag":"li","lines":"287,291"}}],"payload":{"tag":"li","lines":"279,291"}},{"content":"General structure","children":[],"payload":{"tag":"li","lines":"291,292"}},{"content":"","children":[],"payload":{"tag":"li","lines":"292,293"}}],"payload":{"tag":"h2","lines":"278,279"}},{"content":"Paralleism and Network","children":[{"content":"Parallalism","children":[{"content":"Tensor Parallelism","children":[{"content":"\n<p data-lines=\"296,298\">Reduce scatter + All Gather (or)<br>\nAll Reduce (as per raghup)</p>","children":[],"payload":{"tag":"li","lines":"296,298"}},{"content":"\n<p data-lines=\"298,301\">Ultra playbook says:<br>\ncolumn linear: Broadcast + All gather<br>\nRow linear: scatter + All reduce (need to split both input and weight)</p>","children":[],"payload":{"tag":"li","lines":"298,302"}},{"content":"\n<p data-lines=\"302,303\">Terminology depends on what you split: Activations (inputs) * Weights</p>","children":[],"payload":{"tag":"li","lines":"302,303"}}],"payload":{"tag":"li","lines":"295,303"}},{"content":"Pipeline Parallelism","children":[{"content":"Send/Receive","children":[],"payload":{"tag":"li","lines":"304,305"}}],"payload":{"tag":"li","lines":"303,305"}},{"content":"Expert Parallelism","children":[{"content":"All to All","children":[],"payload":{"tag":"li","lines":"306,307"}}],"payload":{"tag":"li","lines":"305,307"}},{"content":"DP (used in training)","children":[{"content":"Reduce Scatter + All Gathe (or)<br>\nAll reduce (hierarchical reduce)","children":[],"payload":{"tag":"li","lines":"308,310"}}],"payload":{"tag":"li","lines":"307,310"}}],"payload":{"tag":"li","lines":"294,310"}},{"content":"Collectives:","children":[{"content":"\n<p data-lines=\"311,312\">Reduce</p>","children":[{"content":"M shards N nodes -&gt; reduce to 1 reduced Shard per Node","children":[],"payload":{"tag":"li","lines":"312,313"}},{"content":"M00   M01    M00+M01  0<br>\nM10   M11    0        M10+M11<br>\nN0     N1","children":[],"payload":{"tag":"li","lines":"313,317"}}],"payload":{"tag":"li","lines":"311,317"}},{"content":"\n<p data-lines=\"317,318\">All Reduce</p>","children":[{"content":"Everyone reduces and share it with everyone","children":[],"payload":{"tag":"li","lines":"318,319"}},{"content":"M shards N nodes -&gt; every one has M shards (reduced like addition)<br>\nM00   M01    M00+M01  M00+M01<br>\nM10   M11    M10+M11  M10+M11<br>\nM20   M21    M20+M21  M20+M21<br>\nM30   M31    M30+M31  M30+M31<br>\nN0    N1     N0       N1","children":[],"payload":{"tag":"li","lines":"319,327"}}],"payload":{"tag":"li","lines":"317,327"}},{"content":"\n<p data-lines=\"327,328\">All Gather</p>","children":[{"content":"Every one gathers from everyone","children":[],"payload":{"tag":"li","lines":"328,330"}}],"payload":{"tag":"li","lines":"327,330"}},{"content":"","children":[],"payload":{"tag":"li","lines":"330,331"}},{"content":"\n<p data-lines=\"331,332\">BGP</p>","children":[],"payload":{"tag":"li","lines":"331,333"}}],"payload":{"tag":"li","lines":"310,333"}}],"payload":{"tag":"h2","lines":"293,294"}},{"content":"Back of envelope latency numbers:","children":[{"content":"Optical single - 4.9ns/m","children":[],"payload":{"tag":"li","lines":"334,335"}},{"content":"Optical Hollow - 3.5ns/m","children":[],"payload":{"tag":"li","lines":"335,336"}},{"content":"Copper        - 4.6ns/m","children":[],"payload":{"tag":"li","lines":"336,337"}},{"content":"Typical length - 5m/10m","children":[],"payload":{"tag":"li","lines":"337,338"}},{"content":"Noc to ethernet - 100ns","children":[],"payload":{"tag":"li","lines":"338,339"}},{"content":"Ethernet to emac ip - 100ns","children":[],"payload":{"tag":"li","lines":"339,340"}},{"content":"switch latency - &lt;250: juniper 750ns","children":[],"payload":{"tag":"li","lines":"340,341"}},{"content":"HBM2E -&gt; 461GB/s, cpacity of 64GB (2 gb per die/ 8 die per stack/4 stack)<br>\nmax could be: 256B","children":[],"payload":{"tag":"li","lines":"341,343"}},{"content":"PCIE <img src=\"/Users/lakshmis/Personal/localweb/site/mindmap/PCI_Speed.png\" alt=\"speed\">","children":[],"payload":{"tag":"li","lines":"343,344"}}],"payload":{"tag":"h2","lines":"333,334"}}],"payload":{"tag":"h1","lines":"8,9"}},{"content":"META","children":[{"content":"RTSW - Rack Training Switch","children":[],"payload":{"tag":"li","lines":"345,346"}},{"content":"FTSW - Fabrci training switch","children":[],"payload":{"tag":"li","lines":"346,347"}},{"content":"STSW - Spine training","children":[],"payload":{"tag":"li","lines":"347,348"}},{"content":"72GPUS&lt;-1-&gt;GB300&lt;--24--&gt; RTSW","children":[],"payload":{"tag":"li","lines":"348,349"}},{"content":"Pod     3  GB300&lt;- 216(72gpus * 3GB)--&gt; (24 * 9RTSW)","children":[],"payload":{"tag":"li","lines":"349,350"}},{"content":"DSF","children":[{"content":"(DSF - packet is reordered in the switch","children":[],"payload":{"tag":"li","lines":"351,352"}}],"payload":{"tag":"li","lines":"350,352"}},{"content":"NSF [Non scheduled Fabric][https://www.youtube.com/watch?v=ELtoxc4g9JI]","children":[{"content":"(GB300, RTSW, FTSW) -&gt; POD/AI zone","children":[{"content":"shallow buffer (160 MB buffer)","children":[],"payload":{"tag":"li","lines":"354,355"}},{"content":"CC: ECN + PFC","children":[],"payload":{"tag":"li","lines":"355,356"}},{"content":"Adaptive routing enabled in NIC","children":[],"payload":{"tag":"li","lines":"356,357"}},{"content":"flowlet based and packet based (Depends on the collectives)","children":[],"payload":{"tag":"li","lines":"357,358"}},{"content":"Global Adaptive routing [Global Adaptive BGP][https://www.youtube.com/watch?v=LFigppFFDRc]","children":[{"content":"Link failure (Capacity reduces)","children":[],"payload":{"tag":"li","lines":"359,360"}},{"content":"Congestion at spine and spreads across","children":[],"payload":{"tag":"li","lines":"360,361"}},{"content":"Adaptive routing works on local load","children":[],"payload":{"tag":"li","lines":"361,362"}},{"content":"Solution: Get remote capacity and source RTSW does path pruning.","children":[],"payload":{"tag":"li","lines":"362,363"}},{"content":"Devil is in the details here: Adaptive routing with different next hop group","children":[],"payload":{"tag":"li","lines":"363,364"}},{"content":"So congestion is closer to the source","children":[],"payload":{"tag":"li","lines":"364,365"}},{"content":"Use BGP link hop bw attribute","children":[],"payload":{"tag":"li","lines":"365,366"}},{"content":"Proliferatin of next hops -&gt; ECMP random spray","children":[],"payload":{"tag":"li","lines":"366,367"}},{"content":"Flow let based adaptive routing: micro flow1, 2,3 -&gt; chopped to form macro flow with inter frame gap<br>\neach macro flow has a different next hop (achieved using DLB)","children":[],"payload":{"tag":"li","lines":"367,369"}}],"payload":{"tag":"li","lines":"358,369"}}],"payload":{"tag":"li","lines":"353,369"}}],"payload":{"tag":"li","lines":"352,369"}}],"payload":{"tag":"h1","lines":"344,345"}},{"content":"Terminology","children":[{"content":"\n<p data-lines=\"370,371\">Flowlet switching</p>","children":[{"content":"A Flow is split into multiple flows. Each sub flows are sent with Inter frame gap<br>\nSo no reorder","children":[],"payload":{"tag":"li","lines":"371,373"}}],"payload":{"tag":"li","lines":"370,373"}},{"content":"\n<p data-lines=\"373,374\">ECMP random sparay</p>","children":[],"payload":{"tag":"li","lines":"373,374"}},{"content":"\n<p data-lines=\"374,375\">(Adaptive routing)[https://www.youtube.com/watch?v=cgYOpp4xwQ8]</p>","children":[{"content":"Flow let based adaptive routing: micro flow1, 2,3 -&gt; chopped to form macro flow with inter frame gap<br>\neach macro flow has a different next hop (achieved using DLB)","children":[],"payload":{"tag":"li","lines":"376,378"}}],"payload":{"tag":"li","lines":"374,378"}}],"payload":{"tag":"h1","lines":"369,370"}},{"content":"Systems","children":[{"content":"Drivers","children":[{"content":"module_init( has say init function)","children":[],"payload":{"tag":"li","lines":"380,381"}},{"content":"init function registers the module_ops","children":[],"payload":{"tag":"li","lines":"381,382"}},{"content":"uses pci_register() to identify the pci devices, bar etc","children":[],"payload":{"tag":"li","lines":"382,383"}},{"content":"and that calls a callback to .probe","children":[],"payload":{"tag":"li","lines":"383,384"}},{"content":"Interrupts","children":[{"content":"IRQ","children":[{"content":"hardware raises an IRQ in the top number","children":[],"payload":{"tag":"li","lines":"386,387"}},{"content":"woken up thread handles the IRQ","children":[],"payload":{"tag":"li","lines":"387,388"}},{"content":"calls softIRQ","children":[],"payload":{"tag":"li","lines":"388,389"}},{"content":"Previously softIRQ is handles by a chosen victim thread","children":[],"payload":{"tag":"li","lines":"389,390"}},{"content":"instead improvmenets were made where a at the exit points of IRQ handler<br>\nthe recently queues softIRQ is handled.","children":[],"payload":{"tag":"li","lines":"390,392"}},{"content":"ksoftirqd is still handles if the softIRQ is substantial","children":[],"payload":{"tag":"li","lines":"392,393"}}],"payload":{"tag":"li","lines":"385,393"}},{"content":"softIRQ <a href=\"https://lwn.net/Articles/520076/\">softirq victim</a>","children":[{"content":"Defered interrupt handling","children":[],"payload":{"tag":"li","lines":"394,395"}},{"content":"for example netif_rx or netif_recv_cb causes softirq","children":[],"payload":{"tag":"li","lines":"395,396"}},{"content":"ksoftirqd  -&gt; handles the interrupts","children":[],"payload":{"tag":"li","lines":"396,397"}},{"content":"but ksofritrqd will be triggered only when a choosen process couldn't handle all softirq","children":[],"payload":{"tag":"li","lines":"397,398"}},{"content":"","children":[],"payload":{"tag":"li","lines":"398,399"}}],"payload":{"tag":"li","lines":"393,399"}}],"payload":{"tag":"li","lines":"384,399"}},{"content":"Reference implementation:<br>\n- https://github.com/amzn/amzn-drivers/blob/master/kernel/linux/ena/ena_netdev.c<br>\n- Pensando driver","children":[],"payload":{"tag":"li","lines":"399,402"}}],"payload":{"tag":"h2","lines":"379,380"}},{"content":"Network","children":[{"content":"Drivers <a href=\"https://www.kernel.org/doc/html/latest/networking/scaling.html\">scaling network in linux stack</a>","children":[{"content":"Watch the youtube video <a href=\"https://www.youtube.com/watch?v=DLUHLwaduzU\">ethernet drivers</a>","children":[],"payload":{"tag":"li","lines":"404,405"}},{"content":"sk_buff structure to copy the packets","children":[],"payload":{"tag":"li","lines":"405,406"}},{"content":"net_device is how kernel identifies a device","children":[],"payload":{"tag":"li","lines":"406,407"}},{"content":".probe() is how a device is registered","children":[],"payload":{"tag":"li","lines":"407,408"}},{"content":"register_netdev() results in it being user visible","children":[],"payload":{"tag":"li","lines":"408,409"}},{"content":"net_rx_action() softirq handler will handle the packet","children":[],"payload":{"tag":"li","lines":"409,410"}},{"content":"netdev_ops , NDOs registerd as part of probe","children":[],"payload":{"tag":"li","lines":"410,411"}},{"content":"Tx:","children":[{"content":"App creates sk_buff","children":[],"payload":{"tag":"li","lines":"412,413"}}],"payload":{"tag":"li","lines":"411,413"}},{"content":"Rx <a href=\"https://andreaskaris.github.io/blog/networking/rss-irq-affinity-and-rps/\">rx primer</a>","children":[{"content":"register for interrupt on i/f up or at device open: request_irq is the function","children":[],"payload":{"tag":"li","lines":"414,415"}},{"content":"On nic initialisation, a thread which either polls or interrupts (irq / hw irq)","children":[],"payload":{"tag":"li","lines":"415,416"}},{"content":"Once a pakcet is there, it copied to the sk_buff","children":[],"payload":{"tag":"li","lines":"416,417"}},{"content":"then netif_rx is called","children":[],"payload":{"tag":"li","lines":"417,418"}},{"content":"Napi","children":[{"content":"netif_recv_skb is called","children":[],"payload":{"tag":"li","lines":"419,420"}},{"content":"napi_schedule is called from the interrupt handler","children":[],"payload":{"tag":"li","lines":"420,421"}},{"content":"used in high throughput situration where the rx interrupt fires<br>\nand switches to napi poll","children":[],"payload":{"tag":"li","lines":"421,423"}}],"payload":{"tag":"li","lines":"418,423"}},{"content":"Multiple queues, associate cpu with differnt cores","children":[],"payload":{"tag":"li","lines":"423,424"}},{"content":"RSS (Receive side scaling)","children":[{"content":"maps interrupts to groups of cpus","children":[],"payload":{"tag":"li","lines":"425,426"}},{"content":"dedicated irq number","children":[],"payload":{"tag":"li","lines":"426,427"}},{"content":"uses /proc/irq/85/smp_affinity to get cpus (calculates hash)","children":[],"payload":{"tag":"li","lines":"427,428"}},{"content":"hardware driven","children":[],"payload":{"tag":"li","lines":"428,429"}},{"content":"ethtool -x <if> <shows the=\"\" rss=\"\" hash=\"\"></shows></if>","children":[],"payload":{"tag":"li","lines":"429,430"}},{"content":"ethtool -l eth1 &lt;gives the rx/tx queues&gt;","children":[],"payload":{"tag":"li","lines":"430,431"}},{"content":"cat /proc/irq/472/smp_affinity &lt;cat /proc/interrupts | grep 'CPU|snni0'&gt;<br>\n00000000,00000000,00010000,00000000","children":[],"payload":{"tag":"li","lines":"431,433"}},{"content":"Thor seem to have 16 such queues.","children":[],"payload":{"tag":"li","lines":"433,434"}},{"content":"netif_rx (places in per cpu backlog_queue)","children":[],"payload":{"tag":"li","lines":"434,435"}}],"payload":{"tag":"li","lines":"424,435"}},{"content":"RPS","children":[{"content":"places the packet in the backlog queue","children":[],"payload":{"tag":"li","lines":"436,437"}},{"content":"netif_recv_skb uses rpc_cpus to choose the cpu to send queue","children":[],"payload":{"tag":"li","lines":"437,438"}},{"content":"/sys/class/net/<iface>/queues/rx_N/rps_cpus gives the cpus</iface>","children":[],"payload":{"tag":"li","lines":"438,439"}},{"content":"interrupt is still delivered to a cpu based on RSS/default mechanism","children":[],"payload":{"tag":"li","lines":"439,440"}}],"payload":{"tag":"li","lines":"435,440"}},{"content":"RFS","children":[],"payload":{"tag":"li","lines":"440,441"}},{"content":"XPS","children":[],"payload":{"tag":"li","lines":"441,442"}}],"payload":{"tag":"li","lines":"413,442"}}],"payload":{"tag":"li","lines":"403,442"}},{"content":"Virtual Machines","children":[{"content":"Problem is packet has to be copied from nic to hypervisor to vm","children":[],"payload":{"tag":"li","lines":"443,444"}},{"content":"core that is interrupted could be different from core that has the vm","children":[],"payload":{"tag":"li","lines":"444,445"}},{"content":"VMDq","children":[],"payload":{"tag":"li","lines":"445,446"}},{"content":"SRIOV [Single Root IO Virtualisation][https://www.youtube.com/watch?v=hRHsk8Nycdg&amp;t=19s]","children":[{"content":"Some resources are allocated to VFs. It is hardware specific","children":[],"payload":{"tag":"li","lines":"447,448"}},{"content":"Packet arrives and nic places into VF based on MAC/Vlan","children":[],"payload":{"tag":"li","lines":"448,449"}},{"content":"DMA's directly to the VM via DMA controller (this does the IoRemap)","children":[],"payload":{"tag":"li","lines":"449,450"}}],"payload":{"tag":"li","lines":"446,450"}}],"payload":{"tag":"li","lines":"442,450"}},{"content":"TCP/IP","children":[{"content":"focus of network stack of TCP/IP","children":[],"payload":{"tag":"li","lines":"451,452"}}],"payload":{"tag":"li","lines":"450,452"}},{"content":"RDMA (also covered in AI networking)","children":[],"payload":{"tag":"li","lines":"452,453"}},{"content":"High-throughput and Flexible Host Networking for Accelerated Computing Read this paper","children":[],"payload":{"tag":"li","lines":"453,455"}}],"payload":{"tag":"h2","lines":"402,403"}},{"content":"PCI <a href=\"https://docs.kernel.org/PCI/index.html\">pci driver</a>","children":[{"content":"ioremap","children":[],"payload":{"tag":"li","lines":"456,457"}},{"content":"speed 4GB/s in ond direction","children":[],"payload":{"tag":"li","lines":"457,458"}},{"content":"16 links 16 * 4 = 64GB/s","children":[],"payload":{"tag":"li","lines":"458,459"}},{"content":"Nvlink","children":[{"content":"50 GB/s (previous version)<br>\n100 GB/s (current version)<br>\n18 links --&gt; 1.8 TB/s","children":[],"payload":{"tag":"li","lines":"460,463"}}],"payload":{"tag":"li","lines":"459,463"}}],"payload":{"tag":"h2","lines":"455,456"}},{"content":"DMA","children":[{"content":"Host memory (RAM)","children":[],"payload":{"tag":"li","lines":"464,465"}},{"content":"Device memory","children":[{"content":"Attached to Accelerator","children":[],"payload":{"tag":"li","lines":"466,467"}},{"content":"Separate from the accelerator like GPU to HBM","children":[],"payload":{"tag":"li","lines":"467,468"}}],"payload":{"tag":"li","lines":"465,468"}},{"content":"Allocation","children":[{"content":"Kernel dma_alloc_coherent() / kmalloc","children":[],"payload":{"tag":"li","lines":"469,470"}},{"content":"User space use mmap","children":[],"payload":{"tag":"li","lines":"470,471"}}],"payload":{"tag":"li","lines":"468,471"}},{"content":"IOVA Address Space","children":[{"content":"X virtual address","children":[],"payload":{"tag":"li","lines":"472,473"}},{"content":"Y physical address","children":[],"payload":{"tag":"li","lines":"473,474"}},{"content":"Z == same Y if no IOMMU or xlated by IOMMU.","children":[],"payload":{"tag":"li","lines":"474,475"}},{"content":"Z is from IOVA (IOVirtual address space)","children":[],"payload":{"tag":"li","lines":"475,476"}},{"content":"There is a concept of domain and same Z in two different device can point<br>\nto different Y in the CPU address space","children":[],"payload":{"tag":"li","lines":"476,478"}}],"payload":{"tag":"li","lines":"471,478"}},{"content":"MMIO Address space","children":[{"content":"This actual memory of device mapped into CPU adddress space","children":[],"payload":{"tag":"li","lines":"479,480"}}],"payload":{"tag":"li","lines":"478,480"}},{"content":"Xfer from Device to Host: (RAM)","children":[{"content":"Alloc memory (virtual)","children":[],"payload":{"tag":"li","lines":"481,482"}},{"content":"get physical","children":[],"payload":{"tag":"li","lines":"482,483"}},{"content":"get IOVA (DMA address) and program it in the device","children":[],"payload":{"tag":"li","lines":"483,484"}},{"content":"Driver uses Alloc memory (v) and Device uses DMA","children":[],"payload":{"tag":"li","lines":"484,485"}}],"payload":{"tag":"li","lines":"480,485"}},{"content":"Xfer from Device to Device MMIO Space","children":[{"content":"Not supported","children":[],"payload":{"tag":"li","lines":"486,487"}}],"payload":{"tag":"li","lines":"485,487"}},{"content":"Xfer from Device memory to Peer Device Memory(assume on separate to GPU): <a href=\"https://docs.kernel.org/driver-api/pci/p2pdma.html\">p2p dma</a>","children":[{"content":"Ex: RDU attached HBM or GPU attached Memory,","children":[],"payload":{"tag":"li","lines":"488,489"}},{"content":"Give directly the dma/physical address","children":[],"payload":{"tag":"li","lines":"489,490"}},{"content":"Must map it to the MMIO Bar, p2pDMA must be supported","children":[],"payload":{"tag":"li","lines":"490,491"}},{"content":"Workflow","children":[{"content":"Driver has to register the memory using   pci_p2pdma_add_resource(pdev, BAR2, 0, 0))","children":[],"payload":{"tag":"li","lines":"492,493"}},{"content":"Driver has to call this pci_p2pmem_publish() to get the memory","children":[],"payload":{"tag":"li","lines":"493,494"}}],"payload":{"tag":"li","lines":"491,494"}},{"content":"Cannot use apis dma_map_single(), dma_alloc_coherent()","children":[],"payload":{"tag":"li","lines":"494,495"}}],"payload":{"tag":"li","lines":"487,495"}},{"content":"Xfer Device Attached memory: (like RDU)","children":[{"content":"Uses internal NoS (network on switch)","children":[],"payload":{"tag":"li","lines":"496,497"}}],"payload":{"tag":"li","lines":"495,497"}}],"payload":{"tag":"h2","lines":"463,464"}},{"content":"IOMMU","children":[{"content":"Address xlate","children":[],"payload":{"tag":"li","lines":"498,499"}},{"content":"protection","children":[],"payload":{"tag":"li","lines":"499,500"}},{"content":"interrupt virtualisation","children":[],"payload":{"tag":"li","lines":"500,502"}}],"payload":{"tag":"h2","lines":"497,498"}},{"content":"OS","children":[{"content":"Profiling","children":[{"content":"eBpf","children":[{"content":"Programs are written via Cilium, bcc,bpftrace","children":[],"payload":{"tag":"li","lines":"505,506"}},{"content":"helper functions, kfuncs called by bpf","children":[],"payload":{"tag":"li","lines":"506,507"}},{"content":"bcc","children":[{"content":"used for application / system profiling","children":[],"payload":{"tag":"li","lines":"508,509"}},{"content":"python code will generate eBPF bytecode and load it in kernel","children":[],"payload":{"tag":"li","lines":"509,510"}}],"payload":{"tag":"li","lines":"507,510"}},{"content":"bpftrace <a href=\"https://www.brendangregg.com/blog/2019-08-19/bpftrace.html\">intro</a>","children":[],"payload":{"tag":"li","lines":"510,511"}}],"payload":{"tag":"li","lines":"504,511"}},{"content":"ftrace","children":[],"payload":{"tag":"li","lines":"511,512"}}],"payload":{"tag":"li","lines":"503,512"}},{"content":"OS scheduling","children":[],"payload":{"tag":"li","lines":"512,513"}},{"content":"NUMA","children":[{"content":"Non uniform memory access","children":[],"payload":{"tag":"li","lines":"514,515"}},{"content":"Memory is split into nodes and core have affinity to the nodes","children":[],"payload":{"tag":"li","lines":"515,516"}},{"content":"numa local has best performance","children":[],"payload":{"tag":"li","lines":"516,517"}},{"content":"Numa affinity","children":[{"content":"OS does it","children":[],"payload":{"tag":"li","lines":"518,519"}},{"content":"Hardware striping","children":[],"payload":{"tag":"li","lines":"519,520"}},{"content":"Linux","children":[{"content":"uses ACPI to get memory org","children":[],"payload":{"tag":"li","lines":"521,522"}},{"content":"Allocates Zone.","children":[],"payload":{"tag":"li","lines":"522,523"}},{"content":"Zone contains: free memory, unmapped page cache, page mapped, anonymous pages (stack, heap), dirty pages, unevictable pages,","children":[],"payload":{"tag":"li","lines":"523,524"}},{"content":"Memory Allocation policy:","children":[{"content":"Node Local (default)","children":[],"payload":{"tag":"li","lines":"525,526"}},{"content":"Node Interleave (on bootup for kernel)","children":[],"payload":{"tag":"li","lines":"526,527"}}],"payload":{"tag":"li","lines":"524,527"}},{"content":"Numa scheduling","children":[{"content":"when process is preempted and rescheduled, possible in different core","children":[],"payload":{"tag":"li","lines":"528,529"}},{"content":"but cache is in old node","children":[],"payload":{"tag":"li","lines":"529,530"}},{"content":"kernel 3.8 address this but more needed (2013)","children":[],"payload":{"tag":"li","lines":"530,531"}},{"content":"apps use taskset to pin memory to a core","children":[],"payload":{"tag":"li","lines":"531,532"}}],"payload":{"tag":"li","lines":"527,532"}},{"content":"Numa reclaim - has overhead, mapped pages cannot be evicted","children":[{"content":"continue to schedule on same node. no reclaim","children":[],"payload":{"tag":"li","lines":"533,534"}},{"content":"reclaim (default: 0) /proc/sys/vm/zone_reclaim","children":[],"payload":{"tag":"li","lines":"534,535"}},{"content":"/proc/sys/vm/min_unmapped_ratio (can be used to trigger reclaim)","children":[],"payload":{"tag":"li","lines":"535,536"}}],"payload":{"tag":"li","lines":"532,536"}},{"content":"Numa tools","children":[{"content":"numactl -hardare","children":[],"payload":{"tag":"li","lines":"537,538"}},{"content":"numastat","children":[],"payload":{"tag":"li","lines":"538,539"}},{"content":"cat /proc/<pid>/numa_maps</pid>","children":[],"payload":{"tag":"li","lines":"539,540"}},{"content":"/sys/devices/system/node/node<x>/meminfo</x>","children":[],"payload":{"tag":"li","lines":"540,541"}}],"payload":{"tag":"li","lines":"536,541"}}],"payload":{"tag":"li","lines":"520,541"}}],"payload":{"tag":"li","lines":"517,541"}}],"payload":{"tag":"li","lines":"513,541"}}],"payload":{"tag":"h2","lines":"502,503"}},{"content":"Memory","children":[{"content":"Read the everything should know about memory","children":[],"payload":{"tag":"li","lines":"542,543"}},{"content":"L1d, L2, L3 cache","children":[],"payload":{"tag":"li","lines":"543,544"}},{"content":"L1d is shared by the cores.","children":[],"payload":{"tag":"li","lines":"544,545"}},{"content":"Write-back cache line is kept dirty","children":[],"payload":{"tag":"li","lines":"545,546"}},{"content":"Write-through  makes it slow","children":[],"payload":{"tag":"li","lines":"546,547"}},{"content":"MESI protocol : Modified, Exclusive, shared, Invalid","children":[],"payload":{"tag":"li","lines":"547,548"}},{"content":"Virtual Memory","children":[{"content":"MMU in the CPU complex does the translation","children":[],"payload":{"tag":"li","lines":"549,550"}},{"content":"OS sets up the page table","children":[],"payload":{"tag":"li","lines":"550,551"}},{"content":"VA: Directory / Page offset","children":[],"payload":{"tag":"li","lines":"551,552"}},{"content":"Single Level: Directory to get the page, offset within that page","children":[],"payload":{"tag":"li","lines":"552,553"}},{"content":"Multi-level: 4kb is norm. with 12 bits, 20 for page table a lot","children":[],"payload":{"tag":"li","lines":"553,554"}},{"content":"Typical 4 level page table","children":[],"payload":{"tag":"li","lines":"554,555"}},{"content":"Each process will have it own page tree","children":[],"payload":{"tag":"li","lines":"555,556"}},{"content":"To make page walking effiecient, CPU has TLB","children":[],"payload":{"tag":"li","lines":"556,557"}},{"content":"TLB tag masks the final offset as offset within 4KB is not mapped.","children":[],"payload":{"tag":"li","lines":"557,558"}}],"payload":{"tag":"li","lines":"548,558"}},{"content":"Types of Address:","children":[{"content":"User Virtual","children":[{"content":"Malloc (used by TLB, Page table)","children":[],"payload":{"tag":"li","lines":"560,561"}},{"content":"Drivers use ioremap to convert the device address to virtual address","children":[],"payload":{"tag":"li","lines":"561,562"}},{"content":"DMA: kernel allocated buffer(x) mapped to y. called dma_map_single(x)-&gt;gets z<br>\nprograms device with z","children":[],"payload":{"tag":"li","lines":"562,564"}}],"payload":{"tag":"li","lines":"559,564"}},{"content":"Kernel Virtual","children":[{"content":"Physical - device bus address to Physical mmio space is done as part of enumeration","children":[],"payload":{"tag":"li","lines":"565,566"}}],"payload":{"tag":"li","lines":"564,566"}},{"content":"Devices","children":[{"content":"bus address used by devices","children":[],"payload":{"tag":"li","lines":"567,568"}},{"content":"IO-MMU (optional) maps physical to bus address","children":[],"payload":{"tag":"li","lines":"568,569"}},{"content":"Devices are limited by the address bits like (24-bit, 32-bits and so on)","children":[],"payload":{"tag":"li","lines":"569,570"}}],"payload":{"tag":"li","lines":"566,570"}}],"payload":{"tag":"li","lines":"558,570"}}],"payload":{"tag":"h2","lines":"541,542"}},{"content":"Numbers","children":[{"content":"4MB - 22 bits","children":[],"payload":{"tag":"li","lines":"571,572"}},{"content":"1024 - 1KB - 10 bits","children":[],"payload":{"tag":"li","lines":"572,573"}},{"content":"\n<pre data-lines=\"573,574\"><code>         16 bits\n</code></pre>","children":[],"payload":{"tag":"li","lines":"573,574"}}],"payload":{"tag":"h2","lines":"570,571"}}],"payload":{"tag":"h1","lines":"378,379"}}]},{"initialExpandLevel":2})</script>
</body>
</html>

      </div>
      
      
      
    </div>

    
    


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Lakshmi Narasimhan Seshan</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
